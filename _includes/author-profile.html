{% assign primary_author_id = page.author | default: page.authors | first %}
{% assign author = site.author %}

{% if primary_author_id %}
  {% assign data_author = site.data.authors[primary_author_id] %}
  {% if data_author %}
    {% assign author = data_author %}
  {% endif %}
{% endif %}

{% if author %}
  <section class="author-profile" aria-label="Author profile">
    {% if author.avatar %}
      <div class="author-profile__media">
        <img src="{{ author.avatar | relative_url }}" alt="{{ author.name | default: 'Author avatar' }}">
      </div>
    {% endif %}

    <div class="author-profile__body">
      {% if author.name %}
        <h2 class="author-profile__name">{{ author.name }}</h2>
      {% endif %}

      {% if author.bio %}
        <div class="author-profile__bio">{{ author.bio | markdownify }}</div>
      {% endif %}

      {% assign has_meta = author.location or author.company or author.uri %}
      {% if has_meta %}
        <ul class="author-profile__meta">
          {% if author.location %}<li>{{ author.location }}</li>{% endif %}
          {% if author.company %}<li>{{ author.company }}</li>{% endif %}
          {% if author.uri %}
            <li><a href="{{ author.uri }}" target="_blank" rel="noopener">{{ author.uri | replace: 'https://', '' | replace: 'http://', '' }}</a></li>
          {% endif %}
        </ul>
      {% endif %}

      {% assign github_handle = author.github | default: site.github_username %}
      {% assign email_follow_url = author.email_follow_url | default: site.newsletter_url %}
      {% if email_follow_url == nil or email_follow_url == '' %}
        {% if author.email %}
          {% assign email_follow_url = 'mailto:' | append: author.email %}
        {% elsif site.email %}
          {% assign email_follow_url = 'mailto:' | append: site.email %}
        {% endif %}
      {% endif %}
      {% assign email_is_mailto = false %}
      {% if email_follow_url and email_follow_url contains 'mailto:' %}
        {% assign email_is_mailto = true %}
      {% endif %}

      {% if github_handle or email_follow_url %}
        <div class="follow-buttons" role="group" aria-label="Follow">
          {% if github_handle %}
            <a class="follow-button follow-button--github" href="https://github.com/{{ github_handle }}" target="_blank" rel="noopener">
              Follow on GitHub
            </a>
          {% endif %}
          {% if email_follow_url %}
            <a class="follow-button follow-button--email" href="{{ email_follow_url }}"{% unless email_is_mailto %} target="_blank" rel="noopener"{% endunless %}>
              Follow via Email
            </a>
          {% endif %}
        </div>
      {% endif %}

      {% capture author_links %}
        {% if author.links %}
          {% for link in author.links %}
            {% assign url = link.url | default: '' %}
            {% assign label = link.label | default: link.title | default: url %}
            {% if url != '' %}
              {% assign is_external = url contains '://' %}
              {% if is_external %}
                <a class="author-chip" href="{{ url }}" target="_blank" rel="noopener">{{ label }}</a>
              {% else %}
                <a class="author-chip" href="{{ url | relative_url }}">{{ label }}</a>
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% if author.twitter %}
          <a class="author-chip" href="https://twitter.com/{{ author.twitter }}" target="_blank" rel="noopener">Twitter</a>
        {% endif %}
        {% if author.linkedin %}
          <a class="author-chip" href="https://www.linkedin.com/in/{{ author.linkedin }}" target="_blank" rel="noopener">LinkedIn</a>
        {% endif %}
      {% endcapture %}

      {% assign author_links = author_links | strip %}
      {% if author_links != '' %}
        <div class="author-profile__links">{{ author_links }}</div>
      {% endif %}

      {% assign subscribe_action = author.newsletter_action | default: site.newsletter_action %}
      {% if subscribe_action %}
        {% assign subscribe_id = page.url | default: page.id | default: 'site' | slugify %}
        {% assign subscribe_placeholder = author.newsletter_placeholder | default: site.newsletter_placeholder | default: 'you@example.com' %}
        {% assign subscribe_cta = author.newsletter_cta | default: site.newsletter_cta | default: 'Subscribe' %}
        <form class="author-profile__subscribe" action="{{ subscribe_action }}" method="post" target="_blank" novalidate>
          <div class="subscribe-field">
            <label class="sr-only" for="newsletter-email-{{ subscribe_id }}">Email address</label>
            <input id="newsletter-email-{{ subscribe_id }}" name="email" type="email" placeholder="{{ subscribe_placeholder }}" required inputmode="email">
            <button type="submit">{{ subscribe_cta }}</button>
          </div>
          <input type="text" name="hp" tabindex="-1" autocomplete="off" aria-hidden="true" class="sr-only">
        </form>
      {% endif %}
    </div>
  </section>
{% endif %}
